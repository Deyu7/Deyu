# app.py — GSHS 行为问卷 · 抑郁风险预测 · 可视化
# Usage:
#   # 依赖在 requirements.txt 安装，不要在代码里写 pip install
#   streamlit run app.py
#
# 左侧侧边栏可配置：
# - 行为模型 pkl：svm_pca_behavior_pipeline.pkl
# - 模型元数据 json：svm_pca_behavior_meta.json
# - 原始数据 CSV（用于计算人群均值/标准差/百分位）
# - （可选）文本模型 pkl：pipe_text_final.pkl / pipe_text_final2.pkl

import json, os
from pathlib import Path
import numpy as np
import pandas as pd

# —— 安全导入：joblib 不在环境时自动回退到 pickle（仅此为新增，其他逻辑不变）
try:
    import joblib as _joblib
except Exception:
    _joblib = None
import pickle as _pickle

import streamlit as st
import plotly.graph_objects as go
import plotly.express as px

st.set_page_config(page_title="青少年心理健康风险预测", page_icon="🧠", layout="wide")

# ========= 仅新增：把 Qxx 显示为中文题干 =========
QUESTION_LABELS = {
    # 基本信息
    "Q1": "你的年龄？",
    "Q2": "你的性别？",
    "Q3": "你现在的年级？",
    "Q4": "不穿鞋时的身高（米）",
    "Q5": "不穿鞋时的体重（公斤）",

    # 饮食/卫生
    "Q7":  "过去30天，因为家里没有足够的食物而挨饿的频率",
    "Q9":  "过去30天，你通常每天吃水果的次数",
    "Q10": "过去30天，你通常每天吃蔬菜的次数",
    "Q14": "过去30天，你通常每天刷牙的次数",
    "Q15": "过去30天，你饭前洗手的频率",
    "Q17": "过去30天，你如厕后洗手的频率",
    "Q19": "过去30天，你洗手时使用肥皂/香皂的频率",

    # 暴力/伤害与欺凌
    "Q23": "过去12个月，你被人身体攻击的次数",
    "Q24": "过去12个月，你参与肢体冲突的次数",
    "Q25": "过去12个月，你严重受伤的次数",
    "Q26": "过去12个月，你最严重一次受伤时正在做什么",
    "Q27": "过去12个月，你最严重一次受伤的主要原因",
    "Q28": "过去12个月，你最严重一次受伤是如何发生的",
    "Q29": "过去12个月，你最严重一次受伤的伤情类型",
    "Q30": "过去30天，你被欺凌的天数",
    "Q31": "过去30天，你最常遭遇的欺凌方式",

    # 心理健康（多用于标签，不进特征以防泄漏）
    "Q36": "过去12个月，你感到孤独的频率",
    "Q37": "过去12个月，你因担忧而晚上无法入睡的频率",
    "Q38": "过去12个月，你是否持续两周以上几乎每天感到悲伤/绝望并停止日常活动",
    "Q39": "过去12个月，你是否认真考虑过自杀",
    "Q40": "过去12个月，你是否制定过自杀计划",
    "Q41": "你有几个亲密朋友",

    # 烟草
    "Q44": "你第一次尝试吸烟时的年龄",
    "Q45": "过去30天，你吸烟的天数",
    "Q46": "过去30天，你使用其他形式烟草的天数",
    "Q47": "过去12个月，你是否尝试戒烟",
    "Q48": "过去7天，你身边有人吸烟的天数",
    "Q49": "你的父母/监护人是否使用任何形式的烟草",

    # 酒精/药物
    "Q53": "过去30天，你饮酒（至少一杯）的天数",
    "Q54": "过去30天，在饮酒的那些天里，你平均每天喝几杯",
    "Q55": "过去30天，你通常从哪里获得酒精饮料",
    "Q56": "你一生中，喝酒喝到“真的醉了”的次数",
    "Q58": "你一生中，因为喝酒而宿醉/不适/惹麻烦等的次数",
    "Q61": "你一生中使用毒品（摇头丸/MDMA/冰毒/甲基苯丙胺/大麻/海洛因）的次数",

    # 体力活动/久坐/通学
    "Q67": "过去7天，你有多少天每天进行≥60分钟的体力活动",
    "Q68": "平常一周，你有多少天每天进行≥60分钟的体力活动",
    "Q72": "典型的一天，你坐着（看电视/电脑/聊天/其他）的时间",
    "Q73": "过去7天，你有多少天步行或骑自行车上下学",
    "Q74": "
